name: 'Build test and run'
description: 'Build a test for nakama-cpp and run it'
inputs:
  preset:
    description: 'Configure preset name'
    required: true
  nakama-cpp-path:
    description: 'Relative path under $GITHUB_WORKSPACE to the nakama-cpp repository'
    required: true
  native-tool-options:
    description: 'Flags to pass to the underlying build system used by the CMake generator.'
    required: false
runs:
  using: "composite"
  steps:
    - id: build
      run: |
        cmake --preset ${{ inputs.preset }}
        cmake --build ./build/${{ inputs.preset }} --target install -- ${{ inputs.native-tool-options }}
      shell: bash
      working-directory: ${{ inputs.nakama-cpp-path }}/test
    - id: setup-postgres
      uses: ikalnytskyi/action-setup-postgres@v3
      with:
        username: root
        database: nakama
        port: 26257
    - uses: ./nakama-cpp/.github/actions/run-nakama
      with:
        postgres_uri: "${{ steps.setup-postgres.outputs.connection-uri }}"
    - shell: bash
      run: |
        ./${{ inputs.nakama-cpp-path }}/test/out/${{ inputs.preset }}/nakama-test || {
            echo "Test failed, showing Nakama log for diagnostics";
            cat /tmp/nakama.log;
            exit 1;
        }